{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Horror Movie Database</title>
    <link rel="icon" type="image/png" href="{% static 'img/logo_tab.png' %}" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous" />
    <link rel="stylesheet" href="{% static 'css/styles.css' %}" />
    {% block css %} {% endblock %}
  </head>
  <body>
    <div class="cont_area">
      <!-- Menu -->
      {% include 'snippets/navbar.html' %}

      <!-- End of Menu -->
      {% block content %}
      <!-- Banner -->
      <div class="banner">
        <img src="{% static 'img/banner_horror.png' %}" alt="" />
      </div>
      <!-- End of Banner -->
      <!-- Content -->
      {% include "snippets/content.html" %}
      <!-- End of Content -->
      {% endblock %}
      <!-- Footer -->
      <div class="footer">
        <p>Achmad Irfan Afandi Â© 2025</p>
      </div>
      <!-- End of Footer -->
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
    <script>
      const input = document.getElementById("movieSearchInput");
      const dropdown = document.getElementById("searchResults");

      let controller = null;
      let highlightedIndex = -1;

      function escapeHtml(s) {
        return s.replace(/[&<>"']/g, (c) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[c]));
      }

      function debounce(fn, ms = 300) {
        let t;
        return function (...args) {
          clearTimeout(t);
          t = setTimeout(() => fn.apply(this, args), ms);
        };
      }

      async function fetchResults(q) {
        if (controller) controller.abort();
        controller = new AbortController();
        try {
          const res = await fetch(`/search-api/?q=${encodeURIComponent(q)}`, { signal: controller.signal });
          if (!res.ok) return [];
          const json = await res.json();
          return json.results || [];
        } catch (e) {
          if (e.name === "AbortError") return null;
          console.error(e);
          return [];
        }
      }

      function render(results) {
        dropdown.innerHTML = "";
        highlightedIndex = -1;

        if (!results || results.length === 0) {
          dropdown.hidden = true;
          return;
        }

        results.forEach((r) => {
          const item = document.createElement("div");
          item.className = "search-item";
          item.tabIndex = -1;

          const poster = r.poster ? `<img src="${r.poster}" alt="poster">` : `<img src="https://via.placeholder.com/40x60?text=?">`;

          item.innerHTML = `
      ${poster}
      <div>
        <div><strong>${r.title}</strong></div>
        <div style="font-size:12px; color:#666;">${r.year}</div>
      </div>
    `;

          item.addEventListener("click", () => {
            window.location.href = `/movie/${r.id}/`;
          });

          dropdown.appendChild(item);
        });

        dropdown.hidden = false;
      }

      const handleInput = debounce(async function (e) {
        const q = e.target.value.trim();
        if (q.length < 2) {
          dropdown.hidden = true;
          return;
        }
        const results = await fetchResults(q);
        if (results === null) return; // aborted
        render(results, q);
      }, 300);

      input.addEventListener("input", handleInput);

      // hide when click outside
      document.addEventListener("click", (ev) => {
        if (!ev.target.closest(".nav-search")) dropdown.hidden = true;
      });

      // keyboard nav
      input.addEventListener("keydown", (e) => {
        const items = dropdown.querySelectorAll(".search-item");
        if (dropdown.hidden || items.length === 0) return;
        if (e.key === "ArrowDown") {
          e.preventDefault();
          highlightedIndex = Math.min(highlightedIndex + 1, items.length - 1);
          items[highlightedIndex].focus();
        } else if (e.key === "ArrowUp") {
          e.preventDefault();
          highlightedIndex = Math.max(highlightedIndex - 1, 0);
          items[highlightedIndex].focus();
        } else if (e.key === "Enter") {
          const focused = document.activeElement;
          if (focused && focused.classList.contains("search-item")) {
            focused.click();
          }
        } else if (e.key === "Escape") {
          dropdown.hidden = true;
          input.blur();
        }
      });
    </script>
    <!-- <script src="{% static 'js/javascript.js' %}"></script> -->
  </body>
</html>
